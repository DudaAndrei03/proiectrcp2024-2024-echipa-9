
# Server CoAP

The Constrained Application Protocol (CoAP) is a specialized web
   transfer protocol for use with constrained nodes and constrained
   (e.g., low-power, lossy) networks.

   CoAP provides a request/response interaction model between
   application endpoints, supports built-in discovery of services and
   resources, and includes key concepts of the Web such as URIs and
   Internet media types.  CoAP is designed to easily interface with HTTP
   for integration with the Web while meeting specialized requirements
   such as multicast support, very low overhead, and simplicity for
   constrained environments.


## Features

Web protocol fulfilling M2M (Machine to Machine) requirements in constrained environments

- UDP binding with optional reliability supporting unicast and multicast requests.

- Asynchronous message exchanges.

- Low header overhead and parsing complexity.

- URI and Content-type support.

- Simple proxy and caching capabilities.

## CoAP Message Types

CoAP defines four types of messages:

- Confirmable (CON)
- Non-confirmable (NON)
- Acknowledgement (ACK)
- Reset (RST)
## Request/Response Model
- Message Format: CoAP is based on the exchange of compact messages that, by default, are transported over UDP.

- __CoAP messages carry requests and responses__ in a binary format, including method codes like __GET__, __PUT__, __POST__, __DELETE__ , and a specialized method, **JOMAG4**.


```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Ver| T |  TKL  |      Code     |          Message ID           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Token (if any, TKL bytes)                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      Options (if any)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1 1 1 1 1 1 1 1|      Payload (if any)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

## Field Definitions
- 1.Version (Ver): 2-bit integer indicating the CoAP version.

- 2.Type (T): 2-bit integer for message type: CON (0), NON (1), ACK (2), or RST (3).

- 3.Token Length (TKL): 4-bit integer, indicates the Token length (0-8 bytes).
  

- 4.Code: 8-bit integer, representing the method or response.

- 5.Message ID: 16-bit integer to identify messages.
- 6.Token:

   This header structure is followed by the Token value, which may be 0 or 8 bytes (given by the Token Length Field) and which is used to correlate requests and responses. Every message carries a token (even if it is of zero length) and every request carries a token generated by the client that must be replicated by the server in it's response.
    
   The client should generate unique tokens (that are not in use in a source/destination communication) which should be randomized to guard against spoofing of responses (the reason why the length is permitted to be 32 bytes long is to increase the range of possible random values ).

- 7.Payload:

  Following the header, token, and options, if any, comes the optional payload (the actual message sent). If present and of a not null length, it is prefixed by a fixed, one-byte Payload Marker, which indicates the end of options and the start of the payload (it's absence denotes an empty payload).

  Depending on the type of message sent and on the type of the response, the payload can be carried togheter with the acknowledgement or separately. This means that, if the message sent was a confirmable one, the acknowledgement message that acknowledges the request carries the actual data as well. If the message is non-confirmable, no acknowledgement message is sent.

- 8.Options: 

  CoAp defines a number of options that can be included in a message, with each option instance being determined by the Option Number of the specific CoAp option,the length of the Option Value, and the actual Option Value (a sequence of exactly Option Length bytes with the length and format of the Option Value depending on the respective option).

   Instead of specifying the Option Number directly, the instances must appear in order of their Option Numbers and a delta encoding is used between them: the Option Number for each instance is calculated as the sum of its delta and the Option Number of the preceding instance in the message.


   ```
   0   1   2   3   4   5   6   7
   +---------------+---------------+
   |               |               |
   |  Option Delta | Option Length |   1 byte
   |               |               |
   +---------------+---------------+
   \                               \
   /         Option Delta          /   0-2 bytes
   \          (extended)           \
   +-------------------------------+
   \                               \
   /         Option Length         /   0-2 bytes
   \          (extended)           \
   +-------------------------------+
   \                               \
   /                               /
   \                               \
   /         Option Value          /   0 or more bytes
   \                               \
   /                               /
   \                               \
   +-------------------------------+
   ```

## Request/Response semantics

CoAp operates similarly to HTTP, where an endpoint playing the role of a client sends a request to a server, which in return provides a service. Unlike HTTP, requests and responses are exchanged asynchronously over CoAP messages.

### Responses:
   
   After receiving a request, a server responds with a message matched to the request with the help of a client-generated token. This is different from the Message ID matching process, where an ACK message is related to a CON message by means of the Message ID (generated by the sender of a CON message), which must be echoed by the recipient in the ACK message. This process is called Message Correlation.
   
   A response is identified by the Code field in the CoAP header being set to a Response Code which indicates the result of the server's attempt to deal with the request.

   The response code is composed of 8 bits, with the upper three representing the class of the response and the lower 5 bits providing details about the overall class. 

   The three classes of response codes are:

   2 - Success: The request was successfully received, understood, and accepted.

   4 - Client Error: The request contains bad syntax or cannot be fulfilled.

   5 - Server Error: The server failed to fulfill an apparently valid request.

   CoAP code numbers including the Response Code are documented in the format "c.dd", where "c" is the class in decimal, and "dd" is the detail as a two-digit decimal. For example, some important response codes are:

   - Succes 2.xx: 
      
       -2.01 Created: used in response to POST and PUT
     requests. Serves as an upload function.
      
      -2.02 Deleted: only used in 
      response to requests that cause the resource to cease being
      available, such as DELETE.

      -2.04 Changed: in response to POST functions. Serves as a rename/update function.
      
      -2.05 Content: in response to GET functions. Serves as a download function.
   
   - Client Error 4.xx:
      
      -4.00: The format was not understood.

      -4.04: The data could not be found
   
   - Server Error 5.xx:
      
      -This series of Response Codes suggest the server's inabilty to perform a specific request due to a series of different reasons such as bad gateways or unimplemented functions.


### Types of responses:

- 1.Piggybacked:


